{% extends 'base.html' %}
{% load static %}

{% block title %}API Documentation - Inspora{% endblock %}

{% block extra_css %}
<style>
    .endpoint-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.2s ease;
    }
    .endpoint-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .endpoint-card.get { border-left-color: #28a745; }
    .endpoint-card.post { border-left-color: #007bff; }
    .endpoint-card.put { border-left-color: #ffc107; }
    .endpoint-card.delete { border-left-color: #dc3545; }
    .endpoint-card.patch { border-left-color: #6f42c1; }
    
    .method-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .code-block {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        overflow-x: auto;
    }
    
    .response-example {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .nav-pills .nav-link.active {
        background-color: #007bff;
    }
    
    .sidebar {
        position: sticky;
        top: 2rem;
    }
    
    .endpoint-section {
        scroll-margin-top: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3">
            <div class="sidebar">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">API Reference</h5>
                    </div>
                    <div class="card-body p-0">
                        <nav class="nav flex-column nav-pills">
                            <a class="nav-link" href="#authentication">Authentication</a>
                            <a class="nav-link" href="#users">Users</a>
                            <a class="nav-link" href="#teams">Teams</a>
                            <a class="nav-link" href="#projects">Projects</a>
                            <a class="nav-link" href="#tasks">Tasks</a>
                            <a class="nav-link" href="#goals">Goals</a>
                            <a class="nav-link" href="#portfolios">Portfolios</a>
                            <a class="nav-link" href="#templates">Templates</a>
                            <a class="nav-link" href="#forms">Forms</a>
                            <a class="nav-link" href="#automations">Automations</a>
                            <a class="nav-link" href="#notifications">Notifications</a>
                            <a class="nav-link" href="#audit">Audit Logs</a>
                            <a class="nav-link" href="#websockets">WebSockets</a>
                            <a class="nav-link" href="#rate-limiting">Rate Limiting</a>
                            <a class="nav-link" href="#errors">Error Handling</a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="h2">API Documentation</h1>
                <p class="text-muted">Complete API reference for the Inspora platform</p>
            </div>

            <!-- Authentication Section -->
            <section id="authentication" class="endpoint-section mb-5">
                <h2>Authentication</h2>
                <p>Inspora uses JWT (JSON Web Tokens) for API authentication. All API requests must include a valid JWT token in the Authorization header.</p>
                
                <div class="card endpoint-card post mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">POST</span>
                            <code class="fs-6">/api/token/</code>
                        </div>
                        <p class="card-text">Obtain JWT access and refresh tokens.</p>
                        
                        <h6>Request Body:</h6>
                        <div class="code-block">
{
    "username": "your_username",
    "password": "your_password"
}
                        </div>
                        
                        <h6>Response:</h6>
                        <div class="response-example">
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
                        </div>
                        
                        <h6>Usage:</h6>
                        <div class="code-block">
curl -X POST http://localhost:8000/api/token/ \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "password123"}'
                        </div>
                    </div>
                </div>

                <div class="card endpoint-card post mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">POST</span>
                            <code class="fs-6">/api/token/refresh/</code>
                        </div>
                        <p class="card-text">Refresh an expired access token.</p>
                        
                        <h6>Request Body:</h6>
                        <div class="code-block">
{
    "refresh": "your_refresh_token"
}
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>Note:</strong> Include the access token in all subsequent API requests using the Authorization header:
                    <code>Authorization: Bearer &lt;your_access_token&gt;</code>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="endpoint-section mb-5">
                <h2>Users</h2>
                <p>Manage user accounts and profiles.</p>
                
                <div class="card endpoint-card get mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">GET</span>
                            <code class="fs-6">/api/accounts/users/</code>
                        </div>
                        <p class="card-text">List all users (requires admin permissions).</p>
                        
                        <h6>Query Parameters:</h6>
                        <ul>
                            <li><code>search</code> - Search users by name, email, or username</li>
                            <li><code>is_active</code> - Filter by active status</li>
                            <li><code>department</code> - Filter by department</li>
                            <li><code>ordering</code> - Sort by field (e.g., username, date_joined)</li>
                        </ul>
                    </div>
                </div>

                <div class="card endpoint-card post mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-primary me-3">POST</span>
                            <code class="fs-6">/api/accounts/users/</code>
                        </div>
                        <p class="card-text">Create a new user account.</p>
                        
                        <h6>Request Body:</h6>
                        <div class="code-block">
{
    "username": "newuser",
    "email": "user@example.com",
    "password": "secure_password",
    "first_name": "John",
    "last_name": "Doe",
    "job_title": "Developer",
    "department": "Engineering"
}
                        </div>
                    </div>
                </div>

                <div class="card endpoint-card get mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">GET</span>
                            <code class="fs-6">/api/accounts/users/{id}/</code>
                        </div>
                        <p class="card-text">Get user details by ID.</p>
                    </div>
                </div>
            </section>

            <!-- Projects Section -->
            <section id="projects" class="endpoint-section mb-5">
                <h2>Projects</h2>
                <p>Manage projects and project-related data.</p>
                
                <div class="card endpoint-card get mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">GET</span>
                            <code class="fs-6">/api/projects/</code>
                        </div>
                        <p class="card-text">List all projects accessible to the authenticated user.</p>
                        
                        <h6>Query Parameters:</h6>
                        <ul>
                            <li><code>status</code> - Filter by project status</li>
                            <li><code>priority</code> - Filter by priority level</li>
                            <li><code>owner</code> - Filter by project owner</li>
                            <li><code>team</code> - Filter by team</li>
                            <li><code>search</code> - Search by project name or description</li>
                        </ul>
                    </div>
                </div>

                <div class="card endpoint-card post mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-primary me-3">POST</span>
                            <code class="fs-6">/api/projects/</code>
                        </div>
                        <p class="card-text">Create a new project.</p>
                        
                        <h6>Request Body:</h6>
                        <div class="code-block">
{
    "name": "New Project",
    "description": "Project description",
    "status": "planning",
    "priority": "medium",
    "start_date": "2024-01-01",
    "due_date": "2024-12-31",
    "team": 1,
    "tags": ["web", "development"]
}
                        </div>
                    </div>
                </div>

                <div class="card endpoint-card get mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">GET</span>
                            <code class="fs-6">/api/projects/{id}/</code>
                        </div>
                        <p class="card-text">Get project details by ID.</p>
                    </div>
                </div>

                <div class="card endpoint-card put mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-warning me-3">PUT</span>
                            <code class="fs-6">/api/projects/{id}/</code>
                        </div>
                        <p class="card-text">Update project (full update).</p>
                    </div>
                </div>

                <div class="card endpoint-card patch mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-info me-3">PATCH</span>
                            <code class="fs-6">/api/projects/{id}/</code>
                        </div>
                        <p class="card-text">Partially update project.</p>
                    </div>
                </div>

                <div class="card endpoint-card delete mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-danger me-3">DELETE</span>
                            <code class="fs-6">/api/projects/{id}/</code>
                        </div>
                        <p class="card-text">Delete project (requires appropriate permissions).</p>
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks" class="endpoint-section mb-5">
                <h2>Tasks</h2>
                <p>Manage tasks and task-related operations.</p>
                
                <div class="card endpoint-card get mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-success me-3">GET</span>
                            <code class="fs-6">/api/tasks/</code>
                        </div>
                        <p class="card-text">List all tasks accessible to the authenticated user.</p>
                        
                        <h6>Query Parameters:</h6>
                        <ul>
                            <li><code>status</code> - Filter by task status</li>
                            <li><code>priority</code> - Filter by priority level</li>
                            <li><code>assignee</code> - Filter by assigned user</li>
                            <li><code>project</code> - Filter by project</li>
                            <li><code>due_date</code> - Filter by due date</li>
                            <li><code>overdue</code> - Show only overdue tasks</li>
                        </ul>
                    </div>
                </div>

                <div class="card endpoint-card post mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="method-badge bg-primary me-3">POST</span>
                            <code class="fs-6">/api/tasks/</code>
                        </div>
                        <p class="card-text">Create a new task.</p>
                        
                        <h6>Request Body:</h6>
                        <div class="code-block">
{
    "title": "Task Title",
    "description": "Task description",
    "status": "todo",
    "priority": "medium",
    "project": 1,
    "assignee": 2,
    "due_date": "2024-02-01",
    "estimated_hours": 8
}
                        </div>
                    </div>
                </div>
            </section>

            <!-- WebSockets Section -->
            <section id="websockets" class="endpoint-section mb-5">
                <h2>WebSockets</h2>
                <p>Real-time communication for live updates and notifications.</p>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>Connection URLs:</h5>
                        <ul>
                            <li><code>ws://localhost:8000/ws/notifications/</code> - User notifications</li>
                            <li><code>ws://localhost:8000/ws/projects/{project_id}/</code> - Project updates</li>
                            <li><code>ws://localhost:8000/ws/tasks/{task_id}/</code> - Task updates</li>
                        </ul>
                        
                        <h6>Example JavaScript Connection:</h6>
                        <div class="code-block">
const socket = new WebSocket('ws://localhost:8000/ws/notifications/');

socket.onopen = function(e) {
    console.log('WebSocket connection established');
};

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log('Message received:', data);
    
    if (data.type === 'notification') {
        // Handle notification
        showNotification(data.message);
    }
};

socket.onclose = function(event) {
    if (event.wasClean) {
        console.log('Connection closed cleanly');
    } else {
        console.log('Connection died');
    }
};
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rate Limiting Section -->
            <section id="rate-limiting" class="endpoint-section mb-5">
                <h2>Rate Limiting</h2>
                <p>API rate limiting to prevent abuse and ensure fair usage.</p>
                
                <div class="alert alert-warning">
                    <strong>Rate Limits:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Authentication endpoints: 5 requests per minute</li>
                        <li>Read operations: 100 requests per minute</li>
                        <li>Write operations: 30 requests per minute</li>
                        <li>File uploads: 10 requests per minute</li>
                    </ul>
                </div>
                
                <p>Rate limit headers are included in all responses:</p>
                <div class="code-block">
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995200
                </div>
            </section>

            <!-- Error Handling Section -->
            <section id="errors" class="endpoint-section mb-5">
                <h2>Error Handling</h2>
                <p>Standardized error responses for all API endpoints.</p>
                
                <h5>Common HTTP Status Codes:</h5>
                <ul>
                    <li><strong>200</strong> - Success</li>
                    <li><strong>201</strong> - Created</li>
                    <li><strong>400</strong> - Bad Request</li>
                    <li><strong>401</strong> - Unauthorized</li>
                    <li><strong>403</strong> - Forbidden</li>
                    <li><strong>404</strong> - Not Found</li>
                    <li><strong>429</strong> - Too Many Requests</li>
                    <li><strong>500</strong> - Internal Server Error</li>
                </ul>
                
                <h6>Error Response Format:</h6>
                <div class="code-block">
{
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "Validation failed",
        "details": {
            "field_name": ["This field is required."]
        }
    }
}
                        </div>
            </section>

            <!-- SDKs and Examples -->
            <section class="mb-5">
                <h2>SDKs and Examples</h2>
                <p>Official SDKs and code examples for popular programming languages.</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Python SDK</h5>
                                <p class="card-text">Official Python client library for Inspora API.</p>
                                <div class="code-block">
pip install inspora-python-sdk
                                </div>
                                <a href="#" class="btn btn-primary btn-sm">View Documentation</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">JavaScript SDK</h5>
                                <p class="card-text">Official JavaScript/Node.js client library.</p>
                                <div class="code-block">
npm install inspora-js-sdk
                                </div>
                                <a href="#" class="btn btn-primary btn-sm">View Documentation</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Support -->
            <section class="mb-5">
                <h2>Support</h2>
                <p>Need help with the API? Here are some resources:</p>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-book text-primary" style="font-size: 2rem;"></i>
                                <h5 class="card-title">Documentation</h5>
                                <p class="card-text">Comprehensive guides and tutorials</p>
                                <a href="#" class="btn btn-outline-primary">Browse Docs</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-chat-dots text-success" style="font-size: 2rem;"></i>
                                <h5 class="card-title">Community</h5>
                                <p class="card-text">Join our developer community</p>
                                <a href="#" class="btn btn-outline-success">Join Community</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-envelope text-info" style="font-size: 2rem;"></i>
                                <h5 class="card-title">Contact</h5>
                                <p class="card-text">Get in touch with our team</p>
                                <a href="#" class="btn btn-outline-info">Contact Us</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Update active navigation based on scroll position
    window.addEventListener('scroll', function() {
        const sections = document.querySelectorAll('.endpoint-section');
        const navLinks = document.querySelectorAll('.nav-pills .nav-link');
        
        let current = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (window.pageYOffset >= sectionTop - 200) {
                current = section.getAttribute('id');
            }
        });

        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    });

    // Copy code blocks to clipboard
    document.querySelectorAll('.code-block').forEach(block => {
        const copyButton = document.createElement('button');
        copyButton.className = 'btn btn-sm btn-outline-secondary position-absolute';
        copyButton.style.cssText = 'top: 0.5rem; right: 0.5rem;';
        copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
        copyButton.onclick = function() {
            navigator.clipboard.writeText(block.textContent.trim()).then(() => {
                copyButton.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => {
                    copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        };
        
        block.style.position = 'relative';
        block.appendChild(copyButton);
    });
});
</script>
{% endblock %}
